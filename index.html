<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private Multi-User Chat</title>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Arial}
#login,#chat{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%}
#login{background:linear-gradient(135deg,#00a000,#ff0000,#ffcc00,#0000ff,#ff00ff);background-size:400% 400%;animation:rainbowBG 15s ease infinite}
@keyframes rainbowBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
#login input,#login button{padding:12px;margin:8px;width:80%;max-width:300px}
#chat{display:none;background:#007BFF}
#messages{flex:1;overflow-y:auto;width:95%;max-width:600px;margin:10px auto;padding:10px;background:#f0f0f0;border-radius:10px}

.message{
  display:flex;
  width:100%;
  margin:6px 0;
}

.sender{justify-content:flex-end;}
.receiver{justify-content:flex-start;}

.bubble{
  padding:10px;
  border-radius:15px;
  max-width:75%;
}

.sender .bubble{background:#dcf8c6}
.receiver .bubble{background:#ffb6c1}

.avatar{width:30px;height:30px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;margin:0 5px}

.time,.status{font-size:11px;opacity:.6;margin-top:4px}
.reply-box{font-size:12px;background:#eee;padding:5px;border-left:3px solid #555;margin-bottom:5px}

#chat-controls{display:flex;width:95%;max-width:600px;margin-bottom:10px}
#msg{flex:1;padding:10px}
button{padding:10px;margin-left:5px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h2>Private Login</h2>
  <input id="name" placeholder="Your Name">
  <input id="pin" placeholder="PIN" type="password">
  <button onclick="login()">Login</button>
</div>

<!-- CHAT -->
<div id="chat">
  <div id="messages"></div>
  <div id="chat-controls">
    <input id="msg" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
    <button id="recordBtn">ðŸŽ¤ Record</button>
  </div>
</div>

<audio id="notifSound" src="https://www.soundjay.com/button/sounds/button-10.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ===== FIREBASE =====
const firebaseConfig={
  apiKey:"AIzaSyB44cXr29RuwC95yI87FGn1lZnPVKMozRU",
  authDomain:"pvtapp-4d511.firebaseapp.com",
  databaseURL:"https://pvtapp-4d511-default-rtdb.firebaseio.com",
  projectId:"pvtapp-4d511"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// ===== GLOBALS =====
const PIN="280999";
const CHAT_KEY="shared_chat";
let currentUser="";
let replyTo=null;
let mediaRecorder,audioChunks=[];
let startX=0; // for swipe reply

// ===== LOGIN =====
function login(){
  const nameInput = document.getElementById("name");
  const pinInput = document.getElementById("pin");
  const loginDiv = document.getElementById("login");
  const chatDiv = document.getElementById("chat");

  if(nameInput.value.trim() === ""){
    alert("Enter name");
    return;
  }

  if(pinInput.value !== PIN){
    alert("Invalid PIN");
    return;
  }

  currentUser = nameInput.value.trim();
  loginDiv.style.display = "none";
  chatDiv.style.display = "flex";
  listenMessages();
}

// ===== BASE64 â†’ BLOB =====
function base64ToBlob(base64){
  const parts=base64.split(',');
  const byteString=atob(parts[1]);
  const mime=parts[0].split(':')[1].split(';')[0];
  const ab=new ArrayBuffer(byteString.length);
  const ia=new Uint8Array(ab);
  for(let i=0;i<byteString.length;i++)ia[i]=byteString.charCodeAt(i);
  return new Blob([ab],{type:mime});
}

// ===== ADD MESSAGE =====
function addMessage(msg){
  const wrap=document.createElement("div");
  wrap.className="message "+(msg.user===currentUser?"sender":"receiver");

  const avatar=document.createElement("div");
  avatar.className="avatar";
  avatar.textContent=msg.name[0].toUpperCase();

  const bubble=document.createElement("div");
  bubble.className="bubble";

  if(msg.reply){
    const r=document.createElement("div");
    r.className="reply-box";
    r.textContent=msg.reply;
    bubble.appendChild(r);
  }

  if(msg.type==="audio"){
    const blob=base64ToBlob(msg.content);
    const url=URL.createObjectURL(blob);
    const audio=document.createElement("audio");
    audio.src=url;
    audio.controls=true;
    const dl=document.createElement("a");
    dl.href=url;
    dl.download="voice-message.webm";
    dl.textContent="â¬‡ Download";
    bubble.append(audio,dl);
  }else{
    bubble.append(msg.content);
  }

  // SWIPE RIGHT TO REPLY
  bubble.addEventListener("touchstart", e => { startX = e.touches[0].clientX; });
  bubble.addEventListener("touchend", e => {
    const endX = e.changedTouches[0].clientX;
    if(endX - startX > 60){
      replyTo = msg.content;
      document.getElementById("msg").placeholder="Replying to messageâ€¦";
    }
  });

  // Desktop mouse support
  bubble.addEventListener("mousedown", e => { startX = e.clientX; });
  bubble.addEventListener("mouseup", e => {
    if(e.clientX - startX > 60){
      replyTo = msg.content;
      document.getElementById("msg").placeholder="Replying to messageâ€¦";
    }
  });

  const time=document.createElement("div");
  time.className="time";
  time.textContent=new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  bubble.appendChild(time);

  if(msg.user===currentUser){
    const st=document.createElement("div");
    st.className="status";
    st.textContent=msg.status==="read"?"âœ”âœ” Read":"âœ” Delivered";
    bubble.appendChild(st);
    wrap.append(bubble,avatar);
  }else{
    wrap.append(avatar,bubble);
    document.getElementById("notifSound").play();
  }

  const messages=document.getElementById("messages");
  messages.appendChild(wrap);
  messages.scrollTop=messages.scrollHeight;
}

// ===== SEND TEXT =====
function sendMessage(){
  const msgInput=document.getElementById("msg");
  if(!msgInput.value)return;

  db.ref(CHAT_KEY).push({
    user:currentUser,
    name:currentUser,
    type:"text",
    content:msgInput.value,
    reply:replyTo,
    timestamp:Date.now(),
    status:"sent"
  });

  replyTo=null;
  msgInput.placeholder="Type a message";
  msgInput.value="";
}

// ===== RECORD / SEND AUDIO =====
const recordBtn=document.getElementById("recordBtn");

recordBtn.onclick=async()=>{
  if(!mediaRecorder||mediaRecorder.state==="inactive"){
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);

    mediaRecorder.onstop=()=>{
      const blob=new Blob(audioChunks,{type:"audio/webm"});
      const reader=new FileReader();
      reader.onload=()=>db.ref(CHAT_KEY).push({
        user:currentUser,
        name:currentUser,
        type:"audio",
        content:reader.result,
        timestamp:Date.now(),
        status:"sent"
      });
      reader.readAsDataURL(blob);
      recordBtn.textContent="ðŸŽ¤ Record";
    };

    mediaRecorder.start();
    recordBtn.textContent="ðŸ“¤ Send";
  }else{
    mediaRecorder.stop();
  }
};

// ===== LISTEN =====
function listenMessages(){
  db.ref(CHAT_KEY).on("child_added",snap=>{
    const msg=snap.val();
    if(msg.user!==currentUser && msg.status!=="read"){
      snap.ref.update({status:"read"});
    }
    addMessage(msg);
  });
}
</script>

</body>
</html>
