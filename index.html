<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private Multi-User Chat</title>
<style>
body, html {margin:0;padding:0;height:100%;font-family:Arial,sans-serif;font-size:16px;}
#login, #chat{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;width:100%;}
#login{background: linear-gradient(135deg,#00a000,#ff0000,#ffcc00,#0000ff,#ff00ff);background-size: 400% 400%;animation: rainbowBG 15s ease infinite;}
@keyframes rainbowBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
#login input,#login button{padding:12px;margin:8px;font-size:16px;width:80%;max-width:300px;border-radius:5px;border:1px solid #ccc;}
#chat{display:none;height:100%;width:100%;flex-direction:column;background:#007BFF;}
#messages{flex:1;overflow-y:auto;width:95%;max-width:600px;margin:10px auto;padding:10px;background:rgba(240,240,240,0.8);border-radius:10px;display:flex;flex-direction:column;}
.message{display:flex;margin:5px;max-width:80%;align-items:flex-end;}
.bubble{padding:10px;border-radius:20px;word-wrap:break-word;font-size:16px;line-height:1.4;position:relative;}
.sender{justify-content:flex-end;align-self:flex-end;}
.sender .bubble{background:#dcf8c6;border-top-right-radius:0;}
.receiver{justify-content:flex-start;align-self:flex-start;}
.receiver .bubble{background:#ffb6c1;border-top-left-radius:0;}
.avatar-circle{width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;margin:0 5px;background:#fff;}
#chat-controls{display:flex;width:95%;max-width:600px;margin-bottom:10px;}
#msg{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;}
#recordBtn,#sendBtn{padding:10px;margin-left:5px;border-radius:20px;}
.replyBox{font-size:13px;opacity:.7;border-left:3px solid #555;padding-left:6px;margin-bottom:4px}
.meta{font-size:11px;color:#555;text-align:right;margin-top:4px}
audio{max-width:100%;margin-top:5px}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
<h2>Private Login</h2>
<input id="name" placeholder="Your Name (Mandatory)">
<input id="pin" placeholder="Enter PIN" type="password">
<button onclick="login()">Login</button>
</div>
  
<div id="chat">
<div id="messages"></div>
<div id="chat-controls">
<input id="msg" placeholder="Type a message" onkeydown="if(event.key==='Enter')sendMessage()">
<button id="sendBtn" onclick="sendMessage()">Send</button>
<button id="recordBtn">ðŸŽ¤</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB44cXr29RuwC95yI87FGn1lZnPVKMozRU",
  authDomain: "pvtapp-4d511.firebaseapp.com",
  projectId: "pvtapp-4d511",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const PIN="280999", CHAT_KEY="shared_chat";
let currentUser="", mediaRecorder, audioChunks=[], replyContext=null;

// LOGIN
function login(){
  if(pin.value!==PIN||!name.value.trim()) return alert("Wrong login");
  currentUser=name.value.trim();
  login.style.display="none";
  chat.style.display="flex";
  listenMessages();
}

// ADD MESSAGE
function addMessage(key,msg){
  const type=msg.user===currentUser?"sender":"receiver";
  const div=document.createElement("div");
  div.className="message "+type;
  const bubble=document.createElement("div");
  bubble.className="bubble";

  // swipe left to reply
  let startX=0;
  bubble.ontouchstart=e=>startX=e.touches[0].clientX;
  bubble.ontouchend=e=>{
    if(startX-e.changedTouches[0].clientX>40){
      replyContext={user:msg.user,content:msg.type==="audio"?"ðŸŽ¤ Voice":msg.content};
      msgInput.placeholder="Replying to: "+replyContext.content;
    }
  };

  if(msg.replyTo){
    const r=document.createElement("div");
    r.className="replyBox";
    r.textContent=msg.replyTo.user+": "+msg.replyTo.content;
    bubble.appendChild(r);
  }

  if(msg.type==="audio"){
    const a=document.createElement("audio");
    a.src=msg.content;a.controls=true;
    bubble.appendChild(a);
  }else bubble.append(msg.content);

  const meta=document.createElement("div");
  meta.className="meta";
  const time=new Date(msg.timestamp).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
  let seen=msg.seenBy&&Object.keys(msg.seenBy).length>1?" âœ”âœ”":" âœ”";
  meta.textContent=time+(type==="sender"?seen:"");
  bubble.appendChild(meta);

  div.appendChild(bubble);
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;

  if(type==="receiver"){
    db.ref(`${CHAT_KEY}/${key}/seenBy/${currentUser}`).set(true);
  }
}

// SEND TEXT
function sendMessage(){
  if(!msgInput.value.trim())return;
  const data={
    user:currentUser,type:"text",content:msgInput.value,
    timestamp:Date.now(),seenBy:{[currentUser]:true}
  };
  if(replyContext){data.replyTo=replyContext;replyContext=null;msgInput.placeholder="Type a message";}
  db.ref(CHAT_KEY).push(data);
  msgInput.value="";
}

// VOICE ðŸŽ¤ â†’ ðŸ“¤
recordBtn.onclick=async()=>{
  if(!mediaRecorder||mediaRecorder.state==="inactive"){
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    mediaRecorder.onstop=()=>{
      const reader=new FileReader();
      reader.onload=()=>{
        const data={user:currentUser,type:"audio",content:reader.result,
        timestamp:Date.now(),seenBy:{[currentUser]:true}};
        if(replyContext){data.replyTo=replyContext;replyContext=null;}
        db.ref(CHAT_KEY).push(data);
      };
      reader.readAsDataURL(new Blob(audioChunks,{type:"audio/webm"}));
      recordBtn.textContent="ðŸŽ¤";
    };
    mediaRecorder.start();
    recordBtn.textContent="ðŸ“¤";
  }else mediaRecorder.stop();
};

// LISTEN
function listenMessages(){
  db.ref(CHAT_KEY).on("child_added",s=>addMessage(s.key,s.val()));
}
</script>
</body>
</html>
